#include <stdio.h>
#include <stdlib.h>
#include <string.h>

void menu();
void deposit();
void withdrawal();
void view();
int login(const char *acc, const char *pin);  // New function

struct information {
    char name[50];
    char number[20];
    char pin[30];
    char cash[20];
    char date[10];
};

void menu() {
    int choice;
    printf("WELCOME TO TRANSACTION PAGE.\n");
    printf("\n~ Options ~\n");
    printf("1. Deposit money\n");
    printf("2. Withdraw money\n");
    printf("3. View Balance\n");
    printf("4. Exit\n");
    printf("\nPlease select an option: ");
    scanf("%d", &choice);
    getchar();
    system("cls");

    switch (choice) {
        case 1: deposit(); break;
        case 2: withdrawal(); break;
        case 3: view(); break;
        case 4: printf("Goodbye!\n"); break;
        default:
            printf("Invalid choice. Try again.\n");
            menu(); break;
    }
}

void deposit() {
    struct information user;
    printf("\n~ Deposit Section ~\n");

    printf("Enter your name: ");
    scanf("%s", user.name);
    printf("Enter your account number: ");
    scanf("%s", user.number);
    printf("Enter your PIN: ");
    scanf("%s", user.pin);
    printf("Enter amount to deposit: ");
    scanf("%s", user.cash);
    printf("Enter date: ");
    scanf("%s", user.date);

    int depositAmount = atoi(user.cash);

    FILE *fptr = fopen("deposit.txt", "a");
    if (fptr == NULL) {
        printf("Error opening transaction file.\n");
        return;
    }

    fprintf(fptr, "--------------------------\n");
    fprintf(fptr, "Name                :- %s\n", user.name);
    fprintf(fptr, "Account number      :- %s\n", user.number);
    fprintf(fptr, "Password/Pin        :- %s\n", user.pin);
    fprintf(fptr, "Cash Amount         :- %s\n", user.cash);
    fprintf(fptr, "Date                :- %s\n", user.date);
    fprintf(fptr, "--------------------------\n");
    fclose(fptr);

    FILE *fbal = fopen("balance.txt", "r+");
    int balance = 0;
    if (fbal != NULL) {
        fscanf(fbal, "%d", &balance);
        rewind(fbal);
    } else {
        fbal = fopen("balance.txt", "w");
    }

    balance += depositAmount;
    fprintf(fbal, "%d", balance);
    fclose(fbal);

    printf("\nDeposited: %d\n", depositAmount);
    printf("New Balance: %d\n\n", balance);
    menu();
}

void withdrawal() {
//	char file_name[30]
    struct information user;
    printf("\n~ Withdrawal Section ~\n");

    printf("Enter your account number: ");
    scanf("%s", user.number);
    printf("Enter your PIN: ");
    scanf("%s", user.pin);

    if (!login(user.number, user.pin)) {
        printf("Authentication failed.\n");
        menu();
        return;
    }
    else {
    	printf("\nWelcome, Mr. %s", user.name);
	}

    printf("Enter amount to withdraw: ");
    scanf("%s", user.cash);
    printf("Enter date: ");
    scanf("%s", user.date);
    int withdrawalAmount = atoi(user.cash);

    FILE *fbal = fopen("balance.txt", "r+");
    int balance = 0;
    if (fbal == NULL) {
        printf("No existing balance found.\n");
        return;
    }

    fscanf(fbal, "%d", &balance);
    if (withdrawalAmount > balance) {
        printf("Insufficient balance! Transaction cancelled.\n");
        fclose(fbal);
        return;
    }

    rewind(fbal);
    balance -= withdrawalAmount;
    fprintf(fbal, "%d", balance);
    fclose(fbal);

    FILE *fptr = fopen("deposit.txt", "a");
    if (fptr == NULL) {
        printf("Error opening transaction file.\n");
        return;
    }

    fprintf(fptr, "--------------------------\n");
    fprintf(fptr, "Account number      :- %s\n", user.number);
    fprintf(fptr, "Password/Pin        :- %s\n", user.pin);
    fprintf(fptr, "Withdraw Amount     :- %s\n", user.cash);
    fprintf(fptr, "Date                :- %s\n", user.date);
    fprintf(fptr, "--------------------------\n");
    fclose(fptr);

    printf("\nWithdrawn: %d\n", withdrawalAmount);
    printf("New Balance: %d\n\n", balance);
    menu();
}

void view() {
    struct information user;
    printf("\n~ View Balance Page ~\n");

    printf("Enter your account number: ");
    scanf("%s", user.number);
    printf("Enter your PIN: ");
    scanf("%s", user.pin);

    if (!login(user.number, user.pin)) {
        printf("Authentication failed.\n");
        menu();
        return;
    }

    FILE *fbal = fopen("balance.txt", "r");
    int balance = 0;

    if (fbal == NULL) {
        printf("No balance found. Make a deposit first.\n\n");
    } else {
        fscanf(fbal, "%d", &balance);
        printf("Your current balance is: ?%d\n\n", balance);
        fclose(fbal);
    }

    menu();
}

// ?? Login verification based on account number and PIN
int login(const char *acc, const char *pin) {
    FILE *fptr = fopen("deposit.txt", "r");
    if (fptr == NULL) return 0;

    char line[100];
    char file_acc[20], file_pin[30], file_name[30] ;
    while (fgets(line, sizeof(line), fptr)) {
        if (strstr(line, "Account number") != NULL) {
            sscanf(line, "Account number      :- %s", file_acc);
            fgets(line, sizeof(line), fptr);
            sscanf(line, "Password/Pin        :- %s", file_pin);
            fgets(line, sizeof(line), fptr);
            sscanf(line, "Name                :- %s", file_name);

            if (strcmp(acc, file_acc) == 0 && strcmp(pin, file_pin) == 0) {
                fclose(fptr);
                return 1;  // Match
            }
        }
    }

    fclose(fptr);
    return 0;  // No match
}

int main() {
    menu();
    return 0;
}

    }

    menu();
}

